
<!DOCTYPE html>
<html>
  <head>
    <title>Google Realtime Quickstart</title>

    <!-- Load Styles -->
    <link href="https://www.gstatic.com/realtime/quickstart-styles.css" rel="stylesheet" type="text/css"/>

    <!-- Load the Realtime JavaScript library -->
    <script src="https://apis.google.com/js/api.js"></script>

    <!-- Load the utility library -->
    <script src="https://www.gstatic.com/realtime/realtime-client-utils.js"></script>
  </head>
  <link rel="stylesheet" type="text/css" href="../css/styling.css">
  <body>
    <main>
      <h1>Realtime Collaboration Quickstart</h1>
      <p>Now that your application is running, simply type in either text box and see your changes instantly appear in the other one. Open
      this same document in a <a onclick="window.open(window.location.href);return false;" target="_blank">new tab</a> to see it work across tabs.</p>
      <textarea id="text_area_1"></textarea>
      <textarea id="text_area_2"></textarea>
      <button id="auth_button">Authorize</button>
    </main>
    
    <!--TOOLBAR-->
    <table> 
      <tr>
        <td id="btnUndo">undo</td>
        <td id="btnRedo">redo</td> 
        <td id="btnCreateCircle">circle</td>
        <td id="btnCreateEllipse">ellipse</td>
        <td id="btnCreateRect">rectangle</td>
        <td id="btnCreateConnection">connection</td>
        <td id="btnCreateComment">comment</td>
      </tr>
	</table>

    <svg id="svg" width="100%" height="900" style="background-color:#CCC;">
	</svg>

	<!---JAVASCRIPT here down-->
    <script>
	  //VARIABLES
      var clientId = '707956241542-4s76mlqlkm2rol57nneobntvjb6h5sck.apps.googleusercontent.com';
      var localModel;
	  
	  var mouseIsDown = false;
	  var currentX;
	  var currentY;
	  var initalX;
	  var initialY;
	  var tempHtml;

      if (!/^([0-9])$/.test(clientId[0])) {
        alert('Invalid Client ID - did you forget to insert your application Client ID?');
      }
      // Create a new instance of the realtime utility with your client ID.
      var realtimeUtils = new utils.RealtimeUtils({ clientId: clientId });

      authorize();

      function authorize() {
        // Attempt to authorize
        realtimeUtils.authorize(function(response){
          if(response.error){
            // Authorization failed because this is the first time the user has used your application,
            // show the authorize button to prompt them to authorize manually.
            var button = document.getElementById('auth_button');
            button.classList.add('visible');
            button.addEventListener('click', function () {
              realtimeUtils.authorize(function(response){
                start();
              }, true);
            });
          } else {
              start();
          }
        }, false);
      }

      function start() {
        // With auth taken care of, load a file, or create one if there
        // is not an id in the URL.
        var id = realtimeUtils.getParam('id');
        if (id) {
          //allows for custom types (needs to be done before load)
          registerCustomTypes();

          // Load the document id from the URL
          realtimeUtils.load(id.replace('/', ''), onFileLoaded, onFileInitialize);
        } else {
          // Create a new document, add it to the URL
          realtimeUtils.createRealtimeFile('New Quickstart File', function(createResponse) {
            window.history.pushState(null, null, '?id=' + createResponse.id);
            realtimeUtils.load(createResponse.id, onFileLoaded, onFileInitialize);
          });
        }
      }

      // The first time a file is opened, it must be initialized with the
      // document structure. This function will add a collaborative string
      // to our model at the root.
      function onFileInitialize(model) {
        localModel = model;

        var string = model.createString();
        string.setText('Welcome to the Quickstart App!');
        model.getRoot().set('demo_string', string);
      }

      // After a file has been initialized and loaded, we can access the
      // document. We will wire up the data model to the UI.
      function onFileLoaded(doc) {

        localModel = doc.getModel();

        var collaborativeString = doc.getModel().getRoot().get('demo_string');
        wireTextBoxes(collaborativeString);

        drawFromModel();

        alert("file loaded. xcoord: " + localModel.getRoot().get('causalVarShape').xCenter);
      }


      function drawFromModel()
      {
        tempHtml = tempHtml + '<circle cx=' + localModel.getRoot().get('causalVarShape').xCenter + ' cy=' + localModel.getRoot().get('causalVarShape').yCenter + ' r=' + localModel.getRoot().get('causalVarShape').radius + ' stroke="black" stroke-width="3" fill="green" />';
        svg.innerHTML = tempHtml; 
      }

      // Connects the text boxes to the collaborative string
      function wireTextBoxes(collaborativeString) {
        var textArea1 = document.getElementById('text_area_1');
        var textArea2 = document.getElementById('text_area_2');

        gapi.drive.realtime.databinding.bindString(collaborativeString, textArea1);
        gapi.drive.realtime.databinding.bindString(collaborativeString, textArea2);
      }


      // Call this function before calling gapi.drive.realtime.load
      function registerCustomTypes()
      {
          var causalVar = function () { };

          function initializeCausalVar()
          {
            this.xCenter = 10;
            this.yCenter = 10;
            this.radius = 10;
          }

          gapi.drive.realtime.custom.registerType(causalVar, 'causalVar');

          causalVar.prototype.xCenter = gapi.drive.realtime.custom.collaborativeField('xCenter');
          causalVar.prototype.yCenter = gapi.drive.realtime.custom.collaborativeField('yCenter');
          causalVar.prototype.radius = gapi.drive.realtime.custom.collaborativeField('radius');

          gapi.drive.realtime.custom.setInitializer(causalVar, initializeCausalVar);
      }


      function doOnLoaded() {
        // Note that "this" is the newly created object, even though
        // this method is statically defined. The onLoaded event is
        // always called in the context of the loaded object.
        this.addEventListener(gapi.drive.realtime.EventType.OBJECT_CHANGED,
            alert("xCenter: " + this.xCenter));
      }


	//SET TO CREATING 
      document.getElementById("btnCreateCircle").addEventListener("click", 
        function drawVariable()
        {
		      document.getElementById("btnCreateCircle").selected = true;
        }
      );
	  
	  document.getElementById("btnCreateRect").addEventListener("click", 
        function drawVariable()
        {
		 document.getElementById("btnCreateRect").selected = true;
        }
      );
	  
	  document.getElementById("btnCreateEllipse").addEventListener("click", 
        function drawVariable()
        {
		 document.getElementById("btnCreateEllipse").selected = true;
        }
      );
	  
	  
	//Start drawing once clicked after selected a variable
	  document.onmousedown = function(e){
		  if ((document.getElementById("btnCreateCircle").selected)||(document.getElementById("btnCreateRect").selected) || (document.getElementById("btnCreateEllipse"))){
			  mouseIsDown = true;
			  initialX = currentX;
			  initialY = currentY;
			  tempHtml = svg.innerHTML;
		  }
	  }
	  
	 //on mouseup stop drawing  
	  document.onmouseup = function(e){
		  mouseIsDown = false;
		  
		  if ((document.getElementById("btnCreateCircle").selected)){
			  var radius = Math.sqrt( (currentX-initialX)*(currentX-initialX) + (currentY-initialY)*(currentY-initialY) );
			  tempHtml = tempHtml + '<circle cx=' + initialX + ' cy=' + initialY + ' r=' + radius + ' stroke="black" stroke-width="3" fill="red" />';
			  svg.innerHTML = tempHtml; 
			  document.getElementById("btnCreateCircle").selected = false;
				
			//Probably should change this so that there is just variables that are rectangle based (ie: rectangle & ovals)	
			  var causalVarShape = localModel.create('causalVar');
			  causalVarShape.xCenter = initialX;
			  causalVarShape.yCenter = initialY;
        causalVarShape.radius = radius;
	
			  localModel.getRoot().set('causalVarShape', causalVarShape);
			  
			  causalVarShape.addEventListener(gapi.drive.realtime.EventType.VALUE_CHANGED, doValueChanged);

        alert(localModel.getRoot().get('causalVarShape'));
		  }
		  else {
			var width = currentX - initialX;
			var height = currentY - initialY;
			var centerX = (initialX - currentX)/2 + initialX;
			var centerY = (initialY - currentY)/2 + initialY;
			if ((document.getElementById("btnCreateRect").selected)){
			  tempHtml = tempHtml + '<rect x=' + centerX + ' y=' + centerY +' width=' + width + ' height=' + height + ' stroke="black" stroke-width="3" fill="red" />';
			  svg.innerHTML = tempHtml; 
		 	  document.getElementById("btnCreateRect").selected = false;
			  
			}
			else if ((document.getElementById("btnCreateEllipse").selected)){
			  tempHtml = tempHtml + '<ellipse cx=' + centerX + ' cy=' + centerY +' rx=' + width + ' ry=' + height + ' stroke="black" stroke-width="3" fill="red" />';
			  svg.innerHTML = tempHtml; 
		      document.getElementById("btnCreateEllipse").selected = false;
			}
		  }
	  }
		 
	//resize while mouse is moving & down. Always update current X and Y 
	  document.onmousemove = function(e){
		currentX = e.screenX;
		currentY = e.screenY - 356;
		if (mouseIsDown){
			if (document.getElementById("btnCreateCircle").selected){
				var radius = Math.sqrt( (currentX-initialX)*(currentX-initialX) + (currentY-initialY)*(currentY-initialY) );
				svg.innerHTML = tempHtml + '<circle cx=' + initialX + ' cy=' + initialY + ' r=' + radius + ' stroke="black" stroke-width="3" fill="blue" />';	
			}
			else {
				var width = currentX - initialX;
				var height = currentY - initialY;
				var centerX = (initialX - currentX)/2 + initialX;
				var centerY = (initialY - currentY)/2 + initialY;
				if (document.getElementById("btnCreateRect").selected){
					svg.innerHTML = tempHtml + '<rect x=' + centerX + ' y=' + centerY +' width=' + width + ' height=' + height + ' stroke="black" stroke-width="3" fill="blue" />';
				}
				else if(document.getElementById("btnCreateEllipse").selected){
					svg.innerHTML = tempHtml + '<ellipse cx=' + centerX + ' cy=' + centerY +' rx=' + width + ' ry=' + height + ' stroke="black" stroke-width="3" fill="red" />';
				}
					
			}
				
		}
	  }
    </script>
  </body>
</html>